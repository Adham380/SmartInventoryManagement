<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <link href="./stylesheets/style.css" rel="stylesheet">
</head>

<body>

<div class="container mt-4">

    <h1>Inventory Management</h1>

    <!-- Add New Item Form -->
    <form id="addItemForm" action="/addNewItem" method="post">
        <div class="form-group">
            <label for="inputMethod">Enter Item By:</label>
            <select class="form-control" id="inputMethod" name="inputMethod" onchange="updateInputFields()">
                <option value="barcode">Barcode</option>
                <option value="productName">Product Name</option>
                <!-- Additional methods can be added here in the future -->
            </select>
        </div>
        <div class="form-group" id="inputFieldDiv">
            <input type="text" class="form-control" id="inputField" name="inputField" required>
        </div>
        <button type="submit" class="btn btn-primary">Add Item</button>
    </form>

    <div class="d-flex mt-4 justify-content-between align-items-center">
        <input type="text" id="searchBar" class="form-control w-50" placeholder="Search items..." onkeyup="filterItems()">
    </div>

    <!-- Inventory Grid -->
    <div class="row mt-4" id="inventoryGrid">
        <!-- Inventory items will be populated here -->
    </div>
    <div class="mt-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <label>Items per page:</label>
                <select id="itemsPerPage" onchange="updateItemsPerPage()">
                    <option value="4">4</option>
                    <option value="8">8</option>
                    <option value="12">12</option>
                    <option value="16">16</option>
                </select>
            </div>
            <nav>
                <ul class="pagination">
                    <li class="page-item"><a class="page-link" href="javascript:previousPage()">Previous</a></li>
                    <!-- Page numbers can be generated here -->
                    <li class="page-item"><a class="page-link" href="javascript:nextPage()">Next</a></li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- Recipe Finder Form -->
    <form id="recipeFinderForm" class="mt-4">
        <h3>Find Recipe</h3>
        <div class="form-group">
            <label for="diet">Diet:</label>
            <select style="margin-bottom: 0.2vh" class="form-control" id="diet" name="diet">
                <option value="">Any</option>
                <option value="vegan">Vegan</option>
                <option value="vegetarian">Vegetarian</option>
                <option value="glutenFree">Gluten Free</option>
                <!-- Add more diet options as needed -->
            </select>
<!--            number of recipes-->
        <label for="number">Number of Recipes:</label>
        <input type="number" id="number" name="number" min="1" max="10" value="5">
        </div>
        <button type="submit" class="btn btn-primary">Find Recipe</button>
    </form>
    <div class="row mt-4" id="recipesSection">
        <!-- Recipes will be populated here -->
    </div>
    <div class="modal fade" id="recipeModal" tabindex="-1" aria-labelledby="recipeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="recipeModalLabel">Recipe Details</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="recipeModalBody">
                    <!-- Recipe details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>

    function filterItems() {
        // Declare variables
        let input, filter, inventoryGrid, inventoryItems, inventoryItem, i, txtValue;
        input = document.getElementById('searchBar');
        filter = input.value.toUpperCase();
        inventoryGrid = document.getElementById("inventoryGrid");
        inventoryItems = inventoryGrid.getElementsByClassName('col-md-3');

        //use regex to partially match the title
        const regex = new RegExp(filter, 'i');
        // Loop through all list items, and hide those who don't match the search query
        for (i = 0; i < inventoryItems.length; i++) {
            inventoryItem = inventoryItems[i];
            txtValue = inventoryItem.textContent || inventoryItem.innerText;
            if (txtValue.toUpperCase().match(regex)) {
                inventoryItem.style.display = "";
            } else {
                inventoryItem.style.display = "none";
            }
        }
    }

    let currentPage = 1;
    let itemsPerPage = 8;

    function updateItemsPerPage() {
        itemsPerPage = document.getElementById('itemsPerPage').value;
        renderItems();
    }

    function nextPage() {
        if(currentPage === Math.ceil(document.querySelectorAll('.col-md-3').length / itemsPerPage)) {
            return;
        }
        currentPage++;
        renderItems();
    }

    function previousPage() {
        if(currentPage === 1) {
            return;
        }
        currentPage--;
        renderItems();
    }

    function renderItems() {
        const items = document.querySelectorAll('.col-md-3');
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;

        items.forEach((item, index) => {
            if (index >= startIndex && index < endIndex) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
    // ... Additional logic for rendering items based on pagination

    const form = document.getElementById('addItemForm');
    const barcodeInput = document.getElementById('barcode');

    function updateInputFields() {
        const inputMethod = document.getElementById('inputMethod').value;
        const inputFieldDiv = document.getElementById('inputFieldDiv');
        const inputField = document.getElementById('inputField');

        if (inputMethod === 'barcode') {
            inputField.setAttribute('placeholder', 'Enter Barcode');
        } else if (inputMethod === 'productName') {
            inputField.setAttribute('placeholder', 'Enter Product Name');
        }
        // Additional conditions for new methods can be added here in the future
    }

    // Initial call to set the correct placeholder on page load
    updateInputFields();


    form.addEventListener('submit', async (e) => {
        e.preventDefault(); // prevent default form submission behavior

        const inputMethod = document.getElementById('inputMethod').value;
        const inputValue = document.getElementById('inputField').value;

        let endpoint;
        let payload;

        if (inputMethod === 'barcode') {
            endpoint = '/addNewItem';
            payload = { barcode: inputValue };
        } else if (inputMethod === 'productName') {
            endpoint = '/addItemByTitle';
            payload = { title: inputValue };
        }
        // Additional conditions for new methods can be added here in the future

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            console.log(response.status);
            if(response.status === 200) {
                //clear input field
                // success
                await fetchAndDisplayInventory()
            } else {
                // error
                alert('Error adding item!');
            }
            document.getElementById('inputField').value = '';

            // Rest of the submission logic remains the same

        } catch (error) {
            console.error('Error:', error);
        }
    });


    async function fetchAndDisplayInventory() {
        try {
            const response = await fetch('/getInventory');
            const inventory = await response.json();

            const inventoryGrid = document.getElementById('inventoryGrid');
            // inventoryGrid.innerHTML = ''; // Clear previous items

            for (let title in inventory) {
                const item = inventory[title];

                //check if card already exists and count is equal to item.count card-title card-text in card-body
                //get all card bodies and check
                const cardBodies = document.querySelectorAll('.card-body');
                let cardExists = false;
                cardBodies.forEach(cardBody => {
                    if(cardBody.querySelector('.card-title').textContent === title && cardBody.querySelector('.card-text').textContent == `count: ${item.count}`){
                        cardExists = true;
                        console.log('card exists');
                    } else if (cardBody.querySelector('.card-title').textContent === title && cardBody.querySelector('.card-text').textContent != `count: ${item.count}`){
                        cardExists = true;
                        cardBody.querySelector('.card-text').textContent = `count: ${item.count}`;
                        console.log('card count updated');
                    }
                });
                if(cardExists){
                    continue;
                }

                const itemDiv = document.createElement('div');
                itemDiv.className = 'col-md-3';

                const card = document.createElement('div');
                card.className = 'card mt-2';

                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';

                // Image thumbnail
                const itemImage = document.createElement('img');
                itemImage.className = 'card-img-top';
                if(!item.image.includes('http')){
                itemImage.src = "https://spoonacular.com/cdn/ingredients_500x500/" + item.image;
                } else {
                itemImage.src = item.image;
                }
                itemImage.alt = title;
                card.appendChild(itemImage);

                const titleElement = document.createElement('h5');
                titleElement.className = 'card-title';
                titleElement.textContent = title;
                cardBody.appendChild(titleElement);

                const countElement = document.createElement('p');
                countElement.className = 'card-text';
                countElement.textContent = `count: ${item.count}`;
                cardBody.appendChild(countElement);



                // Checkbox to select the item
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = title;
                checkbox.className = 'itemCheckbox';
                cardBody.appendChild(checkbox);

                const editButton = document.createElement('button');
                editButton.className = 'btn btn-outline-secondary btn-sm edit-button';
                editButton.innerHTML = '<i class="fas fa-pencil-alt"></i>';
                editButton.addEventListener('click', async () => {
                    // Handle the edit action here
                    const newcount = prompt(`Edit count for ${title}`, item.count);
                    if (newcount && !isNaN(newcount)) {
                        console.log('New count:', newcount);
                        item.count = parseInt(newcount);
                        countElement.textContent = `count: ${item.count}`;
                        //update item
                        const response = await fetch('/updateItem', {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                title: title,
                                count: newcount
                            })
                        });

                        await response.json();
                        if(response.status === 200) {
                            // success
                            alert('Item updated successfully!');
                        } else {
                            // error
                            alert('Error updating item!');
                        }
                        // You can also update the JSON/database here if required
                    }
                });
                // Position the button to the top right of the card
                editButton.style.position = 'absolute';
                editButton.style.top = '10px';
                editButton.style.right = '10px';

                card.appendChild(editButton);
                card.appendChild(cardBody);
                itemDiv.appendChild(card);
                inventoryGrid.appendChild(itemDiv);
                renderItems();
            }
        } catch (error) {
            console.error('Error fetching inventory:', error);
        }
    }

    // Call the function to populate the grid on page load
    fetchAndDisplayInventory();
    function getSelectedItems() {
        const checkboxes = document.querySelectorAll('.itemCheckbox:checked');
        const selectedItems = [];

        checkboxes.forEach(checkbox => {
            selectedItems.push(checkbox.value);
        });

        return selectedItems;
    }

    const recipeFinderForm = document.getElementById('recipeFinderForm');
    const dietInput = document.getElementById('diet');
    //get the selected items and diet and send them to the server to find a recipe with /getRecipe
    recipeFinderForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const selectedItems = getSelectedItems();
        const number = document.getElementById('number').value;
        const dietValue = dietInput.value;
        if(selectedItems.length === 0) {
            //select all items
            const checkboxes = document.querySelectorAll('.itemCheckbox');
            checkboxes.forEach(checkbox => {
                selectedItems.push(checkbox.value);
            });
        }
        try {
            const response = await fetch('/getRecipe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    selectedItems: selectedItems,
                    number: number,
                    diet: dietValue
                })
            });

            const recipes = await response.json();

            if(response.status === 200) {
                // success
                alert('Recipes found successfully!');

                const recipesSection = document.getElementById('recipesSection');
                recipesSection.innerHTML = '';  // Clear previous recipes

                recipes.forEach(recipe => {
                    const recipeDiv = document.createElement('div');
                    recipeDiv.className = 'col-md-3';

                    const card = document.createElement('div');
                    card.className = 'card mt-2';

                    // Attach the recipe ID to the card as a data attribute for easy retrieval
                    card.dataset.recipeId = recipe.id;

                    // Image thumbnail
                    const recipeImage = document.createElement('img');
                    recipeImage.className = 'card-img-top';
                    recipeImage.src = recipe.image;
                    recipeImage.alt = recipe.title;
                    recipeImage.style.cursor = 'pointer';
                    recipeImage.addEventListener('click', () => {
                        displayRecipeModal(card);
                    });
                    card.appendChild(recipeImage);

                    const cardBody = document.createElement('div');
                    cardBody.className = 'card-body';

                    const titleElement = document.createElement('h5');
                    titleElement.className = 'card-title';
                    titleElement.textContent = recipe.title;
                    cardBody.appendChild(titleElement);

                    // Just showing the title and image for now. Adjust for other data as needed.

                    card.appendChild(cardBody);
                    recipeDiv.appendChild(card);
                    recipesSection.appendChild(recipeDiv);
                });

            } else {
                // error
                alert('Error finding recipes!');
            }

        } catch (error) {
            console.error('Error:', error);
        }
    });

   async function displayRecipeModal(recipeCard) {
        const modalBody = document.getElementById('recipeModalBody');
        modalBody.innerHTML = ''; // Clear previous recipe details

        // Retrieve the recipe ID from the clicked card's data attribute
        const recipeId = recipeCard.dataset.recipeId;

        // Fetch the full recipe details using the recipe ID and display them in the modal
        fetch(`/getRecipeDetails/${recipeId}`)
            .then(response => response.json())
            .then(recipeDetails => {
                const titleElement = document.createElement('h3');
                titleElement.textContent = recipeDetails.title;
                modalBody.appendChild(titleElement);

                const recipeImage = document.createElement('img');
                recipeImage.src = recipeDetails.image;
                recipeImage.alt = recipeDetails.title;
                recipeImage.style.display = 'block';
                recipeImage.style.margin = 'auto';
                recipeImage.style.marginBottom = '2vh';
                recipeImage.style.marginTop = '2vh';
                recipeImage.className = 'img-fluid';
                modalBody.appendChild(recipeImage);

                const recipeSourceButton = document.createElement('a');
                recipeSourceButton.href = recipeDetails.sourceUrl;
                //open in new tab
                recipeSourceButton.target = '_blank';
                recipeSourceButton.textContent = 'View Recipe Source';
                recipeSourceButton.className = 'btn btn-primary';

                modalBody.appendChild(recipeSourceButton);
                // Display more recipe details as needed
                // For instance, let's say the recipeDetails contains an 'instructions' property:
                const instructionsElement = document.createElement('p');
                instructionsElement.innerHTML = recipeDetails.instructions;
                modalBody.appendChild(instructionsElement);

                // ... add other details as required ...
                $('#recipeModal').modal('show');

            })
            .catch(error => {
                console.error('Error fetching recipe details:', error);
            });
    }


    //every few seconds, update the inventory
    setInterval(async () => {
        await fetchAndDisplayInventory();
    }, 5000);
</script>



</body>

</html>
